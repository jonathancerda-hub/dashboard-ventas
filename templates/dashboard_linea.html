{% extends 'base.html' %}

{% block head %}<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
.calendario-dia {
    display: flex;
    flex-direction: row;
    align-items: center;
    background: #3498db;
    border-radius: 8px;
    padding: 8px 12px;
    color: white;
    min-width: 60px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    gap: 8px;
}
.dia-numero {
    font-size: 24px;
    font-weight: bold;
    line-height: 1;
}
.dia-texto {
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
}
</style>

<!-- Header estilo Odoo -->
<div class="dashboard-header">
    <div class="header-left">
        <h1><i class="bi bi-bar-chart-line-fill"></i> Dashboard Línea Comercial</h1>
        <span class="header-username">{{ session.user_name }}</span>
    </div>
    
    <!-- Calendario central (botón de día) -->
    <a id="date-picker-trigger" class="calendario-dia" style="cursor: pointer; text-decoration: none;">
        <div class="dia-numero">{{ dia_actual }}</div>
        <div class="dia-texto">
            {% for mes in meses_disponibles %}
                {% if mes.key == mes_seleccionado %}
                    {{ mes.nombre.split()[0][:3] }}
                {% endif %}
            {% endfor %}
        </div>
    </a>
            <div class="header-filters">
                <div class="filter-group">
                    <label for="mes-selector"><i class="bi bi-calendar-month"></i> Mes</label>
                    <select id="mes-selector" onchange="cambiarFiltro()">
                        {% for mes in meses_disponibles %}
                        <option value="{{ mes.key }}" {% if mes.key == mes_seleccionado %}selected{% endif %}>
                            {{ mes.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                        <label for="linea-selector"><i class="bi bi-tag-fill"></i> Línea Comercial</label>
                        <select id="linea-selector" onchange="cambiarFiltro()">
                            {% for linea in lineas_disponibles %}
                            <option value="{{ linea }}" {% if linea.upper() == linea_nombre.upper() %}selected{% endif %}>
                                {{ linea }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
            </div>    <div class="header-nav">
        <a href="{{ url_for('dashboard', mes=mes_seleccionado) }}" class="btn-nav"><i class="bi bi-arrow-left-circle"></i> Volver al Dashboard</a>
        <a href="{{ url_for('logout') }}" class="btn-salir"><i class="bi bi-box-arrow-right"></i> Salir</a>
    </div>
</div>

<div class="dashboard-container">
    <!-- Fila de KPIs -->
    <div class="kpi-row">
        <div class="kpi-card kpi-meta">
            <div class="kpi-label">Meta</div>
            <div class="kpi-value">{% if kpis.meta_total > 0 %}S/ {{ "{:,.0f}".format(kpis.meta_total) }}{% else %}-{% endif %}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Venta</div>
            <div class="kpi-value">{% if kpis.venta_total > 0 %}S/ {{ "{:,.0f}".format(kpis.venta_total) }}{% else %}-{% endif %}</div>
        </div>
        <div class="kpi-card kpi-avance">
            <div class="kpi-label">% Avance</div>
            <div class="kpi-value">{% if kpis.porcentaje_avance > 0 %}{{ "{:.1f} %".format(kpis.porcentaje_avance) }}{% else %}-{% endif %}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Meta IPN</div>
            <div class="kpi-value">{% if kpis.meta_ipn > 0 %}S/ {{ "{:,.0f}".format(kpis.meta_ipn) }}{% else %}-{% endif %}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Venta IPN</div>
            <div class="kpi-value">{% if kpis.venta_ipn > 0 %}S/ {{ "{:,.0f}".format(kpis.venta_ipn) }}{% else %}-{% endif %}</div>
        </div>
        <div class="kpi-card kpi-avance">
            <div class="kpi-label">% Avance IPN</div>
            <div class="kpi-value">{% if kpis.porcentaje_avance_ipn > 0 %}{{ "{:.1f} %".format(kpis.porcentaje_avance_ipn) }}{% else %}-{% endif %}</div>
        </div>
    </div>

    <!-- Avance diario -->
    <div class="avance-diario">
        <div class="avance-card">
            <div class="avance-label">Avance Diario Total</div>
            <div class="avance-value">{% if kpis.avance_diario_total > 0 %}{{ "{:.1f} %".format(kpis.avance_diario_total) }}{% else %}-{% endif %}</div>
        </div>
        
        <div class="avance-card">
            <div class="avance-label">Avance Diario IPN</div>
            <div class="avance-value">{% if kpis.avance_diario_ipn > 0 %}{{ "{:.1f} %".format(kpis.avance_diario_ipn) }}{% else %}-{% endif %}</div>
        </div>

        {% if fecha_actual is defined and mes_seleccionado == fecha_actual.strftime('%Y-%m') %}
        {% if mes_seleccionado == fecha_actual.strftime('%Y-%m') %}
        <div class="avance-card avance-requerido">
            <div class="avance-label">Ritmo Diario Requerido de Venta (L-S)</div>
            <div class="avance-value">{% if kpis.ritmo_diario_requerido > 0 %}{{ "{:.1f} %".format(kpis.ritmo_diario_requerido) }}{% else %}¡Meta Cumplida!{% endif %}</div>
        </div>
        {% endif %}
        {% endif %}
    </div>

    <!-- Fila Principal: Tabla y Gráfico Donut -->
    <div class="main-content-row">
        <!-- Tabla de Avance por Vendedor -->
        <div class="tabla-container">
            <div class="tabla-header">
                <h3>Avance por Vendedor - {{ linea_nombre }}</h3>
            </div>
            <table class="tabla-avance">
                <thead>
                    <tr>
                        <th>Vendedor</th>
                        <th>Meta</th>
                        <th>Venta</th>
                        <th>% Cump</th>
                        <th>% Total Vta.</th>
                        <th>Meta IPN</th>
                        <th>Venta IPN</th>
                        <th>% Avance IPN</th>
                        <th>Venc &lt;6 mss</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vendedor in datos_vendedores %}
                    <tr>
                        <td class="text-left">{{ vendedor.nombre }}</td>
                        <td>{% if vendedor.meta > 0 %}{{ "{:,.0f}".format(vendedor.meta) }}{% else %}-{% endif %}</td>
                        <td>{% if vendedor.venta > 0 %}{{ "{:,.0f}".format(vendedor.venta) }}{% else %}-{% endif %}</td>
                        <td class="porcentaje">{% if vendedor.porcentaje_avance > 0 %}{{ "{:.1f}%".format(vendedor.porcentaje_avance) }}{% else %}-{% endif %}</td>
                        <td class="porcentaje">{% if vendedor.porcentaje_sobre_total > 0 %}{{ "%.1f%%"|format(vendedor.porcentaje_sobre_total) }}{% else %}-{% endif %}</td>
                        <td>{% if vendedor.meta_ipn > 0 %}{{ "{:,.0f}".format(vendedor.meta_ipn) }}{% else %}-{% endif %}</td>
                        <td>{% if vendedor.venta_ipn > 0 %}{{ "{:,.0f}".format(vendedor.venta_ipn) }}{% else %}-{% endif %}</td>
                        <td class="porcentaje">{% if vendedor.porcentaje_avance_ipn > 0 %}{{ "{:.1f}%".format(vendedor.porcentaje_avance_ipn) }}{% else %}-{% endif %}</td>
                        <td><strong>{% if vendedor.vencimiento_6_meses > 0 %}{{ "{:,.0f}".format(vendedor.vencimiento_6_meses) }}{% else %}-{% endif %}</strong></td>
                    </tr>
                    {% else %}
                    <tr><td colspan="9" style="text-align: center; padding: 20px;">No hay datos de ventas o metas para esta línea en el mes seleccionado.</td></tr>
                    {% endfor %}
                </tbody>
                <tfoot class="fila-total">
                    <tr>
                        <td class="text-left"><strong>Total</strong></td>
                        <td><strong>{% if kpis.meta_total > 0 %}{{ "{:,.0f}".format(kpis.meta_total) }}{% else %}-{% endif %}</strong></td>
                        <td><strong>{% if kpis.venta_total > 0 %}{{ "{:,.0f}".format(kpis.venta_total) }}{% else %}-{% endif %}</strong></td>
                        <td class="porcentaje"><strong>{% if kpis.porcentaje_avance > 0 %}{{ "{:.1f}%".format(kpis.porcentaje_avance) }}{% else %}-{% endif %}</strong></td>
                        <td class="porcentaje"><strong>100.0%</strong></td>
                        <td><strong>{% if kpis.meta_ipn > 0 %}{{ "{:,.0f}".format(kpis.meta_ipn) }}{% else %}-{% endif %}</strong></td>
                        <td><strong>{% if kpis.venta_ipn > 0 %}{{ "{:,.0f}".format(kpis.venta_ipn) }}{% else %}-{% endif %}</strong></td>
                        <td class="porcentaje"><strong>{% if kpis.porcentaje_avance_ipn > 0 %}{{ "{:.1f}%".format(kpis.porcentaje_avance_ipn) }}{% else %}-{% endif %}</strong></td>
                        <td><strong>{% if kpis.vencimiento_6_meses > 0 %}{{ "{:,.0f}".format(kpis.vencimiento_6_meses) }}{% else %}-{% endif %}</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Gráfico Ciclo de Vida -->
        <div class="grafico-container">
            <h3>Venta por Tipo de Producto</h3>
            <div id="grafico-donut" style="width: 100%; height: 300px;"></div>
        </div>
    </div>

    <!-- Fila Inferior: Gráficos de Barras -->
    <div class="graficos-inferiores">
        <div class="grafico-container">
            <h3>Top 7 Productos Más Vendidos</h3>
            <div class="chart-wrapper" style="position: relative; height: 300px;">
                <canvas id="grafico-productos"></canvas>
            </div>
        </div>
        <div class="grafico-container">
            <h3>Meta vs. Venta por Vendedor</h3>
            <div class="chart-wrapper" style="position: relative; height: 300px;">
                <canvas id="grafico-vendedores-meta-vs-venta"></canvas>
            </div>
        </div>
    </div>
</div>

<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

:root {
    --odoo-primary: #875A7B;
    --odoo-primary-dark: #6B4563;
}

body {
    font-family: 'Poppins', sans-serif;
    background-color: #f0f2f5;
    margin: 0;
    padding: 20px;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, var(--odoo-primary) 0%, var(--odoo-primary-dark) 100%);
    color: white;
    padding: 16px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(135, 90, 123, 0.3);
    margin-bottom: 25px;
}

.header-left {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 2px;
}
.header-left h1 { margin: 0; font-size: 22px; display: flex; align-items: center; gap: 10px;}
.header-username { font-size: 14px; font-weight: 400; color: rgba(255, 255, 255, 0.8); padding-left: 32px; }



.header-filters { display: flex; gap: 20px; align-items: center; }
.filter-group { display: flex; flex-direction: column; gap: 5px; }
.filter-group label { color: rgba(255,255,255,0.8); font-size: 12px; font-weight: 500; }
.filter-group select {
    padding: 8px 12px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    font-size: 14px;
    background-color: rgba(255, 255, 255, 0.1);
    color: white;
}
.filter-group select option { background-color: #333; }

.header-nav { display: flex; gap: 10px; }
.btn-nav, .btn-salir {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    text-decoration: none;
    transition: all 0.2s ease;
}
.btn-nav { background-color: rgba(255, 255, 255, 0.15); color: white; border: 1px solid rgba(255, 255, 255, 0.2); }
.btn-nav:hover { background-color: rgba(255, 255, 255, 0.25); }
.btn-salir { background: #e74c3c; color: white; }
.btn-salir:hover { background-color: #c0392b; }

/* Contenedor del Dashboard */
.dashboard-container { display: flex; flex-direction: column; gap: 25px; }

/* KPIs */
.kpi-row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; }
.kpi-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; }
.kpi-card.kpi-meta { border-left: 4px solid #8e44ad; }
.kpi-card.kpi-avance { background: #fff3cd; }
.kpi-label { font-size: 12px; color: #7f8c8d; margin-bottom: 8px; font-weight: 600; }
.kpi-value { font-size: 18px; font-weight: bold; color: #2c3e50; }

/* Avance Diario */
.avance-diario {
    display: grid; /* Se ajustará automáticamente */
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}
.avance-card {
    background: #ecf0f1;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}
.avance-label { font-size: 14px; color: #7f8c8d; margin-bottom: 5px; }
.avance-value { font-size: 20px; font-weight: bold; color: #e67e22; }

.avance-card.avance-requerido .avance-value {
    color: #e74c3c; /* Rojo para indicar urgencia */
}

/* Layout Principal */
.main-content-row { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; align-items: start; }

/* Tabla */
.tabla-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 20px;
}
.tabla-header h3 { margin: 0 0 15px 0; font-size: 18px; color: var(--odoo-primary); }
.tabla-avance { width: 100%; border-collapse: collapse; font-size: 12px; }
.tabla-avance th { background: var(--odoo-primary); color: white; padding: 12px 8px; text-align: center; font-weight: 600; }
.tabla-avance td { padding: 10px 8px; border-bottom: 1px solid #ecf0f1; text-align: center; }
.tabla-avance .text-left { text-align: left; font-weight: 500; }
.tabla-avance .porcentaje { font-weight: bold; color: #e67e22; }
.tabla-avance tfoot.fila-total { background: var(--odoo-primary) !important; color: white !important; font-weight: bold; }
.tabla-avance tfoot.fila-total td { border-top: 2px solid var(--odoo-primary-dark); color: white !important; }

/* Gráficos */
.grafico-container { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.grafico-container h3 { margin: 0 0 20px 0; font-size: 18px; color: var(--odoo-primary); text-align: center; }
.graficos-inferiores { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }

@media (max-width: 1200px) {
    .kpi-row { grid-template-columns: repeat(3, 1fr); }
    .main-content-row, .graficos-inferiores { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
    .dashboard-header { flex-direction: column; gap: 15px; }
    .kpi-row { grid-template-columns: repeat(2, 1fr); }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Datos del backend
    const datosVendedores = {{ datos_vendedores|tojson|safe }};
    const datosProductos = {{ datos_productos|tojson|safe }};
    const datosCicloVida = {{ datos_ciclo_vida|tojson|safe }};
    const datosFormaFarmaceutica = {{ datos_forma_farmaceutica|tojson|safe }};

    // Función para cambiar de línea comercial
    function cambiarFiltro() {
        const linea = document.getElementById('linea-selector').value;
        const mes = document.getElementById('mes-selector').value;
        const diaElem = document.querySelector('#date-picker-trigger .dia-numero');
        const dia_fin = diaElem ? diaElem.textContent.trim() : null;

        let params = new URLSearchParams();
        params.set('linea_nombre', linea);
        params.set('mes', mes);
        if (dia_fin) {
            params.set('dia_fin', dia_fin);
        }

        window.location.href = `{{ url_for('dashboard_linea') }}?${params.toString()}`;
    }

    // Gráfico Donut: Ciclo de Vida
    function crearGraficoCicloVida() {
        const chartDom = document.getElementById('grafico-donut');
        if (!chartDom) return;
        const myChart = echarts.init(chartDom);
        const seriesData = datosCicloVida.map(item => ({ name: item.ciclo, value: item.venta }));
        const option = {
            tooltip: { trigger: 'item', formatter: '{a}<br/>{b}: S/ {c} ({d}%)' },
            tooltip: { 
                trigger: 'item', 
                formatter: function(params) {
                    const value = (params.value || 0).toLocaleString('es-PE', { style: 'currency', currency: 'PEN', minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    return `${params.seriesName}<br/>${params.name}: ${value} (${params.percent}%)`;
                }
            },
            legend: { top: 'bottom', type: 'scroll' },
            series: [{ name: 'Tipo Producto', type: 'pie', radius: ['40%', '70%'], data: seriesData }]
        };
        myChart.setOption(option);
    }

    // Gráfico Barras: Top Productos
    function crearGraficoProductos() {
        const ctx = document.getElementById('grafico-productos')?.getContext('2d');
        if (!ctx) return;
        const labels = datosProductos.map(p => p.nombre.substring(0, 25) + (p.nombre.length > 25 ? '...' : ''));
        const data = datosProductos.map(p => p.venta);
        new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Venta', data, backgroundColor: '#3498db' }] },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: (context) => `Venta: S/ ${(context.parsed.x || 0).toLocaleString('es-PE', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}` } }
                },
                scales: { x: { beginAtZero: true } }
            }
        });
    }

    // Gráfico Barras Verticales: Meta vs Venta por Vendedor
    function crearGraficoVendedores() {
        const ctx = document.getElementById('grafico-vendedores-meta-vs-venta')?.getContext('2d');
        if (!ctx) return;

        const labels = datosVendedores.map(v => v.nombre);
        const dataMeta = datosVendedores.map(v => v.meta || 0);
        const dataVenta = datosVendedores.map(v => v.venta || 0);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Meta',
                        data: dataMeta,
                        backgroundColor: '#e74c3c',
                    },
                    {
                        label: 'Venta',
                        data: dataVenta,
                        backgroundColor: '#3498db',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { callbacks: { label: (context) => `${context.dataset.label}: S/ ${(context.parsed.y || 0).toLocaleString('es-PE', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}` } }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { callback: value => 'S/ ' + value.toLocaleString() }
                    }
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const mesSeleccionado = document.getElementById('mes-selector').value; // "YYYY-MM"
        const [year, month] = mesSeleccionado.split('-').map(Number);
        const lastDayOfMonth = new Date(year, month, 0).getDate();
        const urlParams = new URLSearchParams(window.location.search);
        const diaFinParam = urlParams.get('dia_fin') || '{{ dia_actual }}';

        flatpickr("#date-picker-trigger", {
            defaultDate: `${mesSeleccionado}-${String(diaFinParam).padStart(2, '0')}`,
            minDate: `${mesSeleccionado}-01`,
            maxDate: `${mesSeleccionado}-${lastDayOfMonth}`,
            dateFormat: "Y-m-d",
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0) {
                    const selectedDay = selectedDates[0].getDate();
                    const diaNumeroEl = document.querySelector('#date-picker-trigger .dia-numero');
                    if (diaNumeroEl) diaNumeroEl.textContent = selectedDay;
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('dia_fin', selectedDay);
                    if (!currentUrl.searchParams.has('mes')) {
                        currentUrl.searchParams.set('mes', mesSeleccionado);
                    }
                    window.location.href = currentUrl.toString();
                }
            },
        });

        crearGraficoCicloVida();
        crearGraficoProductos();
        crearGraficoVendedores();
    });
</script>
{% endblock %}