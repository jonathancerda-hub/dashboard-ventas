{% extends 'base.html' %}

{% block content %}
<header class="page-header">
    <h1 class="page-title">Dashboard de Inventario</h1>
    <div style="display: flex; gap: var(--space-2);">
        <a href="{{ url_for('inventory') }}" class="btn">Volver al Inventario</a>
        <a href="{{ url_for('logout') }}" class="btn btn--primary">Cerrar Sesión</a>
    </div>
</header>

<div class="filter-bar">
    <form method="POST" action="{{ url_for('dashboard') }}">
        <div style="display: flex; flex-wrap: wrap; gap: var(--space-3); align-items: flex-end;">
            <div>
                <label for="category_id">Filtrar por Categoría</label>
                <select name="category_id" id="category_id" class="form-control">
                    <option value="">Todas las Categorías</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if category.id == selected_category_id %}selected{% endif %}>
                            {{ category.display_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="linea_id">Filtrar por Línea Comercial</label>
                <select name="linea_id" id="linea_id" class="form-control">
                    <option value="">Todas las Líneas</option>
                    {% for linea in lineas %}
                        <option value="{{ linea.id }}" {% if linea.id == selected_linea_id %}selected{% endif %}>
                            {{ linea.display_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <button type="submit" class="btn" style="background-color: white; color: var(--color-primary);">Filtrar</button>
            </div>
        </div>
    </form>
</div>

<div class="grid-container">
    <div class="kpi-card">
        <a href="{{ url_for('inventory', grupo_id=selected_category_id, linea_id=selected_linea_id) }}">
            <h2 class="kpi-card__title">Productos Únicos</h2>
            <p class="kpi-card__value">{{ data.kpi_total_products }}</p>
        </a>
    </div>
    <div class="kpi-card">
        <a href="{{ url_for('inventory', grupo_id=selected_category_id, linea_id=selected_linea_id) }}">
            <h2 class="kpi-card__title">Unidades Totales</h2>
            <p class="kpi-card__value">{{ data.kpi_total_quantity }}</p>
        </a>
    </div>
</div>

<div class="chart-container">
    <h2 class="chart-title">Análisis de Vencimiento</h2>
    <div style="display: flex; flex-wrap: wrap; align-items: center; gap: var(--space-4);">
        <div class="alert-card" style="flex: 1; min-width: 200px;">
            <h3 class="alert-card__title">Unidades por Vencer (0-3 Meses)</h3>
            <p class="alert-card__value">{{ data.kpi_vence_pronto }}</p>
        </div>
        <div style="position: relative; height: 300px; flex: 2; min-width: 300px;">
            <div id="expirationChart" style="height: 100%; width: 100%;"></div>
        </div>
    </div>
</div>

<div class="chart-container">
    <h2 class="chart-title">Top 5 Productos por Cantidad</h2>
    <div class="chart-wrapper">
        <canvas id="stockChart"></canvas>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Gráfico de Barras (Top 5) ---
        if (document.getElementById('stockChart')) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            const stockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: {{ data.chart_labels | tojson }},
                    datasets: [{
                        label: 'Cantidad en Stock',
                        data: {{ data.chart_data | tojson }},
                        productIds: {{ data.chart_ids | tojson }},
                        backgroundColor: 'rgba(113, 75, 103, 0.5)',
                        borderColor: 'rgba(113, 75, 103, 1)',
                        borderRadius: 4,
                        borderWidth: 1.5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } },
                    onClick: (event) => {
                        const points = stockChart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const productId = stockChart.data.datasets[firstPoint.datasetIndex].productIds[firstPoint.index];
                            const url = new URL("{{ url_for('inventory', _external=True) }}");
                            url.searchParams.set('product_id', productId);
                            window.location.href = url.toString();
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    }
                }
            });
        }

        // --- Gráfico de Anillo con ECharts ---
        if (document.getElementById('expirationChart')) {
            {% set echarts_data = [] %}
            {% for i in range(data.exp_chart_labels|length) %}
                {% set _ = echarts_data.append({'value': data.exp_chart_data[i], 'name': data.exp_chart_labels[i]}) %}
            {% endfor %}

            const expChartDom = document.getElementById('expirationChart');
            const expChart = echarts.init(expChartDom);
            
            function getResponsiveOptions(width) {
                if (width < 992) {
                    return {
                        legend: { orient: 'horizontal', left: 'center', top: 'bottom', itemGap: 10 },
                        series: { center: ['50%', '45%'] }
                    };
                } else {
                    return {
                        legend: { orient: 'vertical', left: 'left', top: 'center', itemGap: 15, textStyle: { fontSize: 13 } },
                        series: { center: ['65%', '50%'] }
                    };
                }
            }
            
            let responsiveOptions = getResponsiveOptions(window.innerWidth);

            const option = {
                tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                legend: responsiveOptions.legend,
                series: [{
                    name: 'Estado de Vencimiento',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: responsiveOptions.series.center,
                    avoidLabelOverlap: false,
                    padAngle: 5,
                    itemStyle: { borderRadius: 10 },
                    label: { show: false, position: 'center' },
                    emphasis: { label: { show: true, fontSize: '24', fontWeight: 'bold' } },
                    labelLine: { show: false },
                    minAngle: 5,
                    data: {{ echarts_data | tojson }},
                    color: ['#EF4444', '#6B7280', '#10B981', '#3B82F6']
                }]
            };
            expChart.setOption(option);

            expChart.on('click', function (params) {
                const label = params.name;
                let status = '';
                if (label.startsWith('Por Vencer')) { status = 'vence_pronto'; }
                else if (label.startsWith('Advertencia')) { status = 'advertencia'; }
                else if (label.startsWith('OK')) { status = 'ok'; }
                else if (label.startsWith('Largo Plazo')) { status = 'largo_plazo'; }
                
                if (status) {
                    const url = new URL("{{ url_for('inventory', _external=True) }}");
                    url.searchParams.set('exp_status', status);

                    // **MEJORA**: Leemos los filtros activos y los añadimos a la URL
                    const categoryId = {{ selected_category_id|tojson }};
                    const lineaId = {{ selected_linea_id|tojson }};

                    if (categoryId) {
                        url.searchParams.set('grupo_id', categoryId);
                    }
                    if (lineaId) {
                        url.searchParams.set('linea_id', lineaId);
                    }
                    
                    window.location.href = url.toString();
                }
            });

            window.addEventListener('resize', () => {
                responsiveOptions = getResponsiveOptions(window.innerWidth);
                expChart.setOption({
                    legend: responsiveOptions.legend,
                    series: [{ center: responsiveOptions.series.center }]
                });
                expChart.resize(); 
            });
        }
    });
</script>
{% endblock %}