{% extends 'base.html' %}

{% block content %}
<header class="page-header">
    <h1 class="page-title">Dashboard de Inventario</h1>
    <div style="display: flex; gap: var(--space-3);">
        <a href="{{ url_for('inventory') }}" class="btn btn--secondary">Volver al Inventario</a>
        <a href="{{ url_for('logout') }}" class="btn btn--danger">Cerrar Sesión</a>
    </div>
</header>

<div class="card">
    <form method="POST" action="{{ url_for('dashboard') }}" style="display: flex; flex-wrap: wrap; align-items: flex-end; gap: var(--space-3);">
        <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
            <label for="category_id" class="form-label">Filtrar por Categoría</label>
            <select name="category_id" id="category_id" class="form-select">
                <option value="">Todas las Categorías</option>
                {% for category in categories %}
                    <option value="{{ category.id }}" {% if category.id == selected_id %}selected{% endif %}>
                        {{ category.display_name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn--primary">Filtrar</button>
    </form>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-4);">
    <div class="card" style="text-align: center;">
        <h3 class="card-title">Productos Únicos</h3>
        <p style="font-size: var(--font-size-xxl); font-weight: 700; color: var(--color-primary-500); margin: 0;">{{ data.kpi_total_products }}</p>
    </div>
    <div class="card" style="text-align: center;">
        <h3 class="card-title">Unidades Totales</h3>
        <p style="font-size: var(--font-size-xxl); font-weight: 700; color: var(--color-primary-500); margin: 0;">{{ data.kpi_total_quantity }}</p>
    </div>
</div>

<div class="card">
    <h3 class="card-title">Top 5 Productos por Cantidad</h3>
    <div style="position: relative; height: 400px; width: 100%;">
        <canvas id="stockChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('stockChart')) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: {{ data.chart_labels | tojson }},
                    datasets: [{
                        label: 'Cantidad en Stock',
                        data: {{ data.chart_data | tojson }},
                        backgroundColor: 'rgba(79, 70, 229, 0.5)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderRadius: 4,
                        borderWidth: 1.5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } },
                    onClick: (event) => {
                        const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const label = chart.data.labels[firstPoint.index];
                            const url = new URL("{{ url_for('inventory', _external=True) }}");
                            url.searchParams.set('search_term', label);
                            window.location.href = url.toString();
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    }
                }
            });
        }
    });
</script>
{% endblock %}