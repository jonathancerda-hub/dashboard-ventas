{% extends 'base.html' %}

{% block content %}
<header class="page-header">
    <div class="page-header__content">
        <h1 class="page-title">Dashboard de Ventas</h1>
        <p class="page-subtitle">{{ fecha_actual.strftime('%A %d de %B de %Y, %H:%M') }}</p>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('sales') }}" class="btn">Ventas</a>
        <a href="{{ url_for('logout') }}" class="btn btn--primary">Salir</a>
    </div>
</header>

<div class="filter-bar">
    <div class="filter-bar__content">
        <form method="GET" action="{{ url_for('dashboard') }}" class="filter-form">
            
            <div class="filter-group">
                <label for="date_from">DESDE</label>
                <input type="date" name="date_from" id="date_from" value="{{ selected_filters.date_from or '' }}" class="form-control">
            </div>
            
            <div class="filter-group">
                <label for="date_to">HASTA</label>
                <input type="date" name="date_to" id="date_to" value="{{ selected_filters.date_to or '' }}" class="form-control">
            </div>
            
            <div class="filter-group">
                <label for="linea_id">LÍNEA COMERCIAL</label>
                <select name="linea_id" id="linea_id" class="form-select">
                    <option value="">Todas las Líneas</option>
                    {% for linea in filter_options.lineas %}
                        <option value="{{ linea.id }}" {% if linea.id == selected_filters.linea_id %}selected{% endif %}>
                            {{ linea.display_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label for="partner_id">CLIENTE</label>
                <select name="partner_id" id="partner_id" class="form-select">
                    <option value="">Todos los Clientes</option>
                    {% for cliente in filter_options.clientes %}
                        <option value="{{ cliente.id }}" {% if cliente.id == selected_filters.partner_id %}selected{% endif %}>
                            {{ cliente.display_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-actions">
                <button type="submit" class="btn btn--primary">Filtrar</button>
                <a href="{{ url_for('dashboard') }}" class="btn btn--secondary">Limpiar</a>
            </div>
        </form>
    </div>
</div>

<!-- KPIs del Dashboard -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <a href="{{ url_for('sales') }}">
                <div class="kpi-card__title">Total Ventas</div>
                <div class="kpi-card__value">S/ {{ "{:,.2f}".format(dashboard_data.kpi_total_sales if dashboard_data.kpi_total_sales else 0) }}</div>
            </a>
        </div>
        
        <div class="kpi-card">
            <a href="{{ url_for('sales') }}">
                <div class="kpi-card__title">Facturas</div>
                <div class="kpi-card__value">{{ dashboard_data.kpi_total_invoices if dashboard_data.kpi_total_invoices else 0 }}</div>
            </a>
        </div>
    </div>

    <!-- Gráficos del Dashboard -->
    <div class="charts-grid">
        <!-- Gráfico Principal: Ventas por Línea Comercial -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Ventas por Línea Comercial</h3>
            </div>
            <div class="chart-body">
                <canvas id="commercialLinesChart"></canvas>
            </div>
        </div>
        
        <!-- Gráfico Secundario: Ventas por Vendedor -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Ventas por Vendedor</h3>
            </div>
            <div class="chart-body">
                <canvas id="salesBySellerChart"></canvas>
            </div>
        </div>
    </div>

<!-- Scripts para los gráficos -->
<script type="application/json" id="dashboard-data">{{ dashboard_data | tojson | safe }}</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dashboardData = JSON.parse(document.getElementById('dashboard-data').textContent);
    
    // Datos para líneas comerciales
    const commercialLinesData = dashboardData.commercial_lines || [];
    // Datos para vendedores
    const sellersData = dashboardData.sellers || [];
    
    // Configuración minimalista para gráficos
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    padding: 16,
                    font: { size: 12 },
                    usePointStyle: true
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': S/ ' + context.parsed.y.toLocaleString('es-PE', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'S/ ' + value.toLocaleString('es-PE', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        });
                    }
                },
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    maxRotation: 45,
                    minRotation: 0
                }
            }
        }
    };
    
    // Gráfico de Líneas Comerciales
    if (dashboardData.commercial_lines && dashboardData.commercial_lines.length > 0) {
        const ctx = document.getElementById('commercialLinesChart').getContext('2d');
        
        // Extraer datos de líneas comerciales
        const labels = dashboardData.commercial_lines.map(line => line.name || 'Sin Línea');
        const data = dashboardData.commercial_lines.map(line => line.amount || 0);
        
        // Colores dinámicos basados en el monto
        const maxAmount = Math.max(...data);
        const colors = data.map(amount => {
            const intensity = amount / maxAmount;
            return `rgba(25, 118, 210, ${0.3 + intensity * 0.7})`;
        });
        
        const borderColors = data.map(amount => {
            const intensity = amount / maxAmount;
            return `rgba(25, 118, 210, ${0.5 + intensity * 0.5})`;
        });
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ventas por Línea Comercial (S/)',
                    data: data,
                    backgroundColor: colors,
                    borderColor: borderColors,
                    borderWidth: 2,
                    borderRadius: 4,
                    borderSkipped: false,
                }]
            },
            options: chartOptions
        });
    } else {
        // Mostrar mensaje si no hay datos
        const canvas = document.getElementById('commercialLinesChart');
        const ctx = canvas.getContext('2d');
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#666';
        ctx.fillText('No hay datos de líneas comerciales disponibles', canvas.width/2, canvas.height/2);
    }
    
    // Configuración del gráfico de vendedores
    if (sellersData && sellersData.length > 0) {
        const sellersCtx = document.getElementById('salesBySellerChart').getContext('2d');
        
        // Generar colores para el gráfico de vendedores
        const generateSellersColors = (count) => {
            const colors = [];
            const baseColors = [
                '#2ecc71', '#3498db', '#9b59b6', '#e74c3c', '#f39c12',
                '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#16a085'
            ];
            
            for (let i = 0; i < count; i++) {
                if (i < baseColors.length) {
                    colors.push(baseColors[i]);
                } else {
                    const hue = (i * 137.508) % 360;
                    colors.push(`hsl(${hue}, 65%, 55%)`);
                }
            }
            return colors;
        };
        
        const sellersColors = generateSellersColors(sellersData.length);
        
        const salesBySellerChart = new Chart(sellersCtx, {
            type: 'doughnut',
            data: {
                labels: sellersData.map(item => item.name),
                datasets: [{
                    label: 'Ventas por Vendedor (S/)',
                    data: sellersData.map(item => item.amount),
                    backgroundColor: sellersColors,
                    borderColor: '#fff',
                    borderWidth: 3,
                    hoverBorderWidth: 4,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            color: '#333',
                            font: {
                                size: 11
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const dataset = data.datasets[0];
                                        const amount = dataset.data[i];
                                        const total = dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((amount / total) * 100).toFixed(1);
                                        
                                        return {
                                            text: `${label} (${percentage}%)`,
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor,
                                            lineWidth: dataset.borderWidth,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(46, 204, 113, 0.5)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return [
                                    `Vendedor: ${context.label}`,
                                    `Monto: S/ ${context.parsed.toLocaleString('es-PE', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    })}`,
                                    `Participación: ${percentage}%`
                                ];
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 1500
                }
            }
        });
    } else {
        // Mostrar mensaje si no hay datos de vendedores
        const canvas = document.getElementById('salesBySellerChart');
        const ctx = canvas.getContext('2d');
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#666';
        ctx.fillText('No hay datos de vendedores disponibles', canvas.width/2, canvas.height/2);
    }
});
</script>

<style>
/* Mejoras generales del dashboard - Estilo Odoo */
.page-header {
    background: #875A7B;
    color: white;
    padding: var(--space-4) var(--space-6);
    margin-bottom: 0;
    border-bottom: 3px solid #714A67;
    box-shadow: 0 2px 8px rgba(135, 90, 123, 0.2);
}

.page-title {
    font-size: 1.8rem;
    font-weight: 700;
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Filtros mejorados - Estilo Odoo */
.filter-bar {
    background: white;
    padding: var(--space-4) var(--space-6);
    border-bottom: 1px solid #e0e0e0;
    margin: 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.filter-bar form > div {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-4);
    align-items: flex-end;
}

.filter-bar label {
    font-size: 0.8rem;
    font-weight: 600;
    color: #5f6368;
    margin-bottom: var(--space-1);
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.filter-bar .form-control {
    height: 32px;
    border-radius: 4px;
    border: 1px solid #d1d5db;
    padding: 4px 8px;
    font-size: 0.875rem;
    background: white;
    transition: all 0.2s ease;
    min-width: 140px;
}

.filter-bar .form-control:focus {
    border-color: #875A7B;
    box-shadow: 0 0 0 2px rgba(135, 90, 123, 0.1);
    outline: none;
}

.filter-bar .btn {
    height: 32px;
    border-radius: 4px;
    border: 1px solid #875A7B;
    background: #875A7B;
    color: white;
    padding: 4px 16px;
    font-size: 0.875rem;
    font-weight: 600;
    transition: all 0.2s ease;
    cursor: pointer;
}

.filter-bar .btn:hover {
    background: #714A67;
    border-color: #714A67;
}
/* KPIs mejorados */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    padding: 0 var(--space-2);
}

.stats-card {
    background: white;
    border-radius: 12px;
    padding: var(--space-4);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #e0e0e0;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-3);
}

.stats-header h3 {
    margin: 0;
    font-size: 0.9rem;
    color: #666;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stats-icon {
    font-size: 1.8rem;
    opacity: 0.7;
}

.stats-value {
    font-size: 2.2rem;
    font-weight: bold;
    color: #333;
    margin-bottom: var(--space-1);
    line-height: 1.2;
}

.stats-change {
    font-size: 0.85rem;
    color: #666;
    font-weight: 500;
}

.chart-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    border: 1px solid #e0e0e0;
}

.chart-header {
    background: #875A7B;
    color: white;
    padding: var(--space-3) var(--space-4);
    text-align: left;
    margin-bottom: 0;
    border-bottom: 1px solid #714A67;
}

.chart-header h3 {
    margin: 0 0 4px 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: white;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.chart-subtitle {
    margin: 0;
    font-size: 0.8rem;
    opacity: 0.9;
    font-weight: 400;
}

.chart-content {
    padding: var(--space-4);
    position: relative;
    height: 350px;
}

.secondary-chart .chart-content {
    height: 350px;
}

.chart-stats {
    background: #f8f9fa;
    padding: var(--space-3);
    display: flex;
    justify-content: space-around;
    border-top: 1px solid #e0e0e0;
}

.stat-item {
    text-align: center;
}

.stat-label {
    display: block;
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 2px;
}

.stat-value {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    color: #333;
}

/* Responsive design */
@media (max-width: 1200px) {
    .charts-grid {
        grid-template-columns: 1fr;
        gap: var(--space-4);
    }
    
    .chart-content,
    .secondary-chart .chart-content {
        height: 300px;
    }
}

@media (max-width: 768px) {
    .chart-stats {
        flex-direction: column;
        gap: var(--space-2);
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .stat-label, .stat-value {
        display: inline;
    }
}

/* Estilos para el gráfico principal */
.main-chart {
    grid-column: 1 / -1; /* Ocupa todo el ancho */
    background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
    border: 2px solid #e3f2fd;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

.main-chart .chart-header h3 {
    font-size: 1.5rem;
    color: #1976d2;
    margin-bottom: 8px;
}

.chart-subtitle {
    color: #666;
    font-size: 0.9rem;
    margin: 0;
    font-style: italic;
}

.main-chart .chart-content {
    height: 450px;
    padding: 20px;
}

.chart-stats {
    display: flex;
    justify-content: space-around;
    padding: 20px;
    background: rgba(25, 118, 210, 0.05);
    border-top: 1px solid #e3f2fd;
    margin-top: 20px;
}

.stat-item {
    text-align: center;
}

.stat-label {
    display: block;
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 4px;
}

.stat-value {
    display: block;
    font-size: 1.2rem;
    font-weight: bold;
    color: #1976d2;
}

/* Dashboard Container - Estilo Odoo */
.dashboard-container {
    background: #f5f5f5;
    min-height: calc(100vh - 160px);
    overflow-y: auto;
    padding: var(--space-4) var(--space-6);
}

/* Scroll personalizado - Estilo Odoo */
.dashboard-container::-webkit-scrollbar {
    width: 6px;
}

.dashboard-container::-webkit-scrollbar-track {
    background: #e5e7eb;
    border-radius: 3px;
}

.dashboard-container::-webkit-scrollbar-thumb {
    background: #875A7B;
    border-radius: 3px;
}

.dashboard-container::-webkit-scrollbar-thumb:hover {
    background: #714A67;
}

/* Mejoras para el grid de gráficos - LADO A LADO */
.charts-grid {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    width: 100%;
    align-items: stretch;
}

.chart-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    border: 1px solid #e0e0e0;
    flex: 1;
    min-height: 500px;
    display: flex;
    flex-direction: column;
}

.main-chart {
    /* Gráfico izquierdo */
    margin-right: var(--space-2);
}

.secondary-chart {
    /* Gráfico derecho */
    margin-left: var(--space-2);
}

/* Ajustes para gráficos lado a lado */
.chart-content {
    padding: var(--space-3);
    position: relative;
    height: 380px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
}

/* Stats más compactas - Estilo Odoo */
.chart-stats {
    background: #f8f9fa;
    padding: var(--space-3);
    display: flex;
    justify-content: space-around;
    border-top: 1px solid #e0e0e0;
    min-height: 70px;
    align-items: center;
    margin-top: auto;
}

.stat-item {
    text-align: center;
    flex: 1;
}

.stat-label {
    display: block;
    font-size: 0.7rem;
    color: #5f6368;
    margin-bottom: 4px;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.stat-value {
    display: block;
    font-size: 0.9rem;
    font-weight: 700;
    color: #1f2937;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Responsive para pantallas pequeñas */
@media (max-width: 1200px) {
    .charts-grid {
        flex-direction: column;
        gap: var(--space-3);
    }
    
    .main-chart,
    .secondary-chart {
        margin: 0;
    }
    
    .chart-content {
        height: 320px;
    }
    
    .chart-container {
        min-height: 450px;
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: var(--space-2);
        max-height: calc(100vh - 180px);
    }
    
    .chart-stats {
        flex-direction: column;
        gap: var(--space-2);
        padding: var(--space-3);
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }
    
    .stat-label, .stat-value {
        display: inline;
    }
    
    .chart-content {
        height: 280px;
    }
}
</style>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
