<!-- Datos para filtros seleccionados -->
<script type="application/json" id="selected-category-id">{{ selected_category_id | tojson | safe }}</script>
<script type="application/json" id="selected-linea-id">{{ selected_linea_id | tojson | safe }}</script>
<script type="application/json" id="selected-lugar-id">{{ selected_lugar_id | tojson | safe }}</script>
<!-- Datos para gráfico de barras horizontales (por línea) -->
<script type="application/json" id="exp-by-line-labels">{{ data.exp_by_line_labels | tojson | safe }}</script>
<script type="application/json" id="exp-by-line-data">{{ data.exp_by_line_data | tojson | safe }}</script>
{% extends 'base.html' %}

{% block content %}
<header class="page-header">
    <h1 class="page-title">Dashboard de Inventario
        <div id="datetime" style="font-size: 0.5em; color: #888; font-weight: normal; margin-top: 8px;"></div>
    </h1>
    <div style="font-size: 0.95em; color: #888; margin-bottom: 8px;">
        Tiempo de respuesta backend: {{ backend_time }}
    </div>
    <div style="display: flex; gap: var(--space-2);">
        <a href="{{ url_for('inventory') }}" class="btn">Volver al Inventario</a>
        <a href="{{ url_for('logout') }}" class="btn btn--primary">Cerrar Sesión</a>
    </div>
</header>

<div class="filter-bar">
    <form method="POST" action="{{ url_for('dashboard') }}">
        <div style="display: flex; flex-wrap: wrap; gap: var(--space-3); align-items: flex-end;">
            
            <div>
                <label for="linea_id" style="font-size: var(--font-size-sm); margin-bottom: var(--space-2); display: block;">Filtrar por Línea Comercial</label>
                <select name="linea_id" id="linea_id" class="form-control">
                    <option value="">Todas las Líneas</option>
                    {% for linea in lineas %}
                        <option value="{{ linea.id }}" {% if linea.id == selected_linea_id %}selected{% endif %}>
                            {{ linea.display_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="category_id" style="font-size: var(--font-size-sm); margin-bottom: var(--space-2); display: block;">Filtrar por Categoría</label>
                <select name="category_id" id="category_id" class="form-control">
                    <option value="">Todas las Categorías</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if category.id == selected_category_id %}selected{% endif %}>
                            {{ category.display_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="lugar_id" style="font-size: var(--font-size-sm); margin-bottom: var(--space-2); display: block;">Lugar</label>
                <select name="lugar_id" id="lugar_id" class="form-control">
                    <option value="">Todos (def. Comercial)</option>
                    {% for lugar in lugares %}
                        <option value="{{ lugar.id }}" {% if lugar.id == selected_lugar_id %}selected{% endif %}>
                            {{ lugar.display_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <button type="submit" class="btn btn--secondary">Filtrar</button>
            </div>
            <div style="margin-left: auto;">
                <button type="button" id="capture-btn" class="btn"><i class="bi bi-camera"></i> Capturar</button>
            </div>
        </div>
    </form>
</div>

<div class="scrollable-content">
    <div class="grid-container">
        <div class="kpi-card">
            <a href="{{ url_for('inventory', grupo_id=selected_category_id, linea_id=selected_linea_id, lugar_id=selected_lugar_id) }}">
                <h2 class="kpi-card__title">Productos Únicos</h2>
                <p class="kpi-card__value">{{ data.kpi_total_products }}</p>
            </a>
        </div>
        <div class="kpi-card">
            <a href="{{ url_for('inventory', grupo_id=selected_category_id, linea_id=selected_linea_id, lugar_id=selected_lugar_id) }}">
                <h2 class="kpi-card__title">Unidades Totales</h2>
                    <p class="kpi-card__value">{{ '{:,}'.format(data.kpi_total_quantity) }}</p>
            </a>
        </div>
    </div>

    <div class="grid-container" style="display: flex; gap: 24px; margin-top: 32px;">
        <!-- Gráfico de Barras Verticales por Línea Comercial -->
        <div class="chart-container rounded-card" style="flex: 1; min-width: 0;">
            <h2 class="chart-title">Stock por Línea Comercial</h2>
            <div class="chart-wrapper" style="height: 220px;">
                <canvas id="stockByLineChart"></canvas>
            </div>
        </div>
        <!-- Gráfico de Barras Verticales por Categoría -->
        <div class="chart-container rounded-card" style="flex: 1; min-width: 0;">
            <h2 class="chart-title">Stock por Categoría</h2>
            <div class="chart-wrapper" style="height: 220px;">
                <canvas id="stockByCategoryChart"></canvas>
            </div>
        </div>
    </div>


    <div class="grid-container" style="display: flex; gap: 24px;">
        <!-- Gráfico de Pastel -->
        <div class="chart-container rounded-card" style="flex: 1; min-width: 0; padding-bottom: 110px;">
        <div id="expirationChart" style="height: 300px; width: 100%;"></div>
        </div>
        <!-- Gráfico de Barras Horizontales -->
        <div class="chart-container rounded-card" style="flex: 1; min-width: 0;">
            <h2 class="chart-title">Unidades por Vencer (0-3 Meses) por Línea Comercial</h2>
        <div class="chart-wrapper" style="height: 300px;">
                <div id="expiringByLineChart" style="height: 100%; width: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Barras Verticales para Productos por Vencer -->
    <div class="chart-container rounded-card" style="margin-top: 32px;">
        <h2 class="chart-title">Top 5 Productos por Vencer (0-3 Meses)</h2>
        <div class="chart-wrapper" style="height: 220px;">
            <canvas id="expiringSoonChart"></canvas>
        </div>
    </div>

    <!-- Gráfico de Barras Verticales debajo -->
    <div class="chart-container rounded-card" style="margin-top: 32px;">
        <h2 class="chart-title">Top 5 Productos por Cantidad</h2>
        <div class="chart-wrapper" style="height: 220px;">
            <canvas id="stockChart"></canvas>
        </div>
    </div>
</div>


<style>
.rounded-card {
    border-radius: 18px !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    background: #fff;
    border: 1px solid #eee;
    padding: 18px 18px 12px 18px;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

<!-- Datos para gráficos en JSON -->
<script type="application/json" id="chart-data-labels">{{ data.chart_labels | tojson | safe }}</script>
<script type="application/json" id="chart-data-data">{{ data.chart_data | tojson | safe }}</script>
<script type="application/json" id="chart-data-ids">{{ data.chart_ids | tojson | safe }}</script>
<!-- Datos para nuevo gráfico (por vencer) -->
<script type="application/json" id="expiring-soon-labels">{{ data.expiring_soon_labels | tojson | safe }}</script>
<script type="application/json" id="expiring-soon-data">{{ data.expiring_soon_data | tojson | safe }}</script>
<script type="application/json" id="expiring-soon-ids">{{ data.expiring_soon_ids | tojson | safe }}</script>
<!-- Datos para gráfico de pastel (expiración) -->
<script type="application/json" id="exp-chart-labels">{{ data.exp_chart_labels | tojson | safe }}</script>
<script type="application/json" id="exp-chart-data">{{ data.exp_chart_data | tojson | safe }}</script>
<!-- Datos para nuevos gráficos de stock -->
<script type="application/json" id="category-stock-labels">{{ data.category_stock_labels | tojson | safe }}</script>
<script type="application/json" id="category-stock-data">{{ data.category_stock_data | tojson | safe }}</script>
<script type="application/json" id="line-stock-labels">{{ data.line_stock_labels | tojson | safe }}</script>
<script type="application/json" id="line-stock-data">{{ data.line_stock_data | tojson | safe }}</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fecha y Hora
        const now = new Date();
        const formattedDateTime = now.toLocaleString('es-ES', { dateStyle: 'long', timeStyle: 'short' });
        document.getElementById('datetime').textContent = formattedDateTime;

        // Captura de pantalla
        document.getElementById('capture-btn').addEventListener('click', function () {
            const { jsPDF } = window.jspdf;
            const captureElement = document.querySelector('main');
            document.body.classList.add('body--capturing');

            html2canvas(captureElement, {
                useCORS: true,
                allowTaint: true,
            }).then(canvas => {
                document.body.classList.remove('body--capturing');
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                
                const date = new Date().toISOString().slice(0, 10);
                pdf.save(`Dashboard_Inventario_${date}.pdf`);
            });
        });

        // Leer datos desde los bloques JSON
        var chartLabels = JSON.parse(document.getElementById('chart-data-labels').textContent);
        var chartData = JSON.parse(document.getElementById('chart-data-data').textContent);
        var chartIds = JSON.parse(document.getElementById('chart-data-ids').textContent);
        // --- Gráfico de Barras (Stock por Categoría) ---
        if (document.getElementById('stockByCategoryChart')) {
            const categoryStockLabels = JSON.parse(document.getElementById('category-stock-labels').textContent);
            const categoryStockData = JSON.parse(document.getElementById('category-stock-data').textContent);
            const ctx = document.getElementById('stockByCategoryChart').getContext('2d');
            const stockByCategoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categoryStockLabels,
                    datasets: [{
                        label: 'Cantidad en Stock',
                        data: categoryStockData,
                        backgroundColor: '#875A7B',
                        borderColor: '#875A7B',
                        borderRadius: 4,
                        borderWidth: 1.5
                    }]
                },
                options: {
                    animation: { duration: 0 },
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- Gráfico de Barras (Stock por Línea Comercial) ---
        if (document.getElementById('stockByLineChart')) {
            const lineStockLabels = JSON.parse(document.getElementById('line-stock-labels').textContent);
            const lineStockData = JSON.parse(document.getElementById('line-stock-data').textContent);
            const ctx = document.getElementById('stockByLineChart').getContext('2d');
            const stockByLineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: lineStockLabels,
                    datasets: [{
                        label: 'Cantidad en Stock',
                        data: lineStockData,
                        backgroundColor: '#875A7B',
                        borderColor: '#875A7B',
                        borderRadius: 4,
                        borderWidth: 1.5
                    }]
                },
                options: {
                    animation: { duration: 0 },
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- Gráfico de Barras (Top 5 por Vencer) ---
        if (document.getElementById('expiringSoonChart')) {
            const expiringSoonLabels = JSON.parse(document.getElementById('expiring-soon-labels').textContent);
            const expiringSoonData = JSON.parse(document.getElementById('expiring-soon-data').textContent);
            const expiringSoonIds = JSON.parse(document.getElementById('expiring-soon-ids').textContent);
            const ctx = document.getElementById('expiringSoonChart').getContext('2d');
            const expiringSoonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: expiringSoonLabels,
                    datasets: [{
                        label: 'Cantidad por Vencer',
                        data: expiringSoonData,
                        productIds: expiringSoonIds,
                        backgroundColor: '#E53935', // Red color
                        borderColor: '#E53935',
                        borderRadius: 4,
                        borderWidth: 1.5
                    }]
                },
                options: {
                    animation: { duration: 0 },
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } },
                    onClick: (event) => {
                        const points = expiringSoonChart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const productId = expiringSoonChart.data.datasets[firstPoint.datasetIndex].productIds[firstPoint.index];
                            const url = new URL("{{ url_for('inventory', _external=True) }}");
                            url.searchParams.set('product_id', productId);
                            window.location.href = url.toString();
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    }
                }
            });
        }

        // --- Gráfico de Barras (Top 5) ---
        if (document.getElementById('stockChart')) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            const stockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Cantidad en Stock',
                        data: chartData,
                        productIds: chartIds,
                        backgroundColor: '#875A7B',
                        borderColor: '#875A7B',
                        borderRadius: 4,
                        borderWidth: 1.5
                    }]
                },
                options: {
                    animation: { duration: 0 }, // Desactiva la animación
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } },
                    onClick: (event) => {
                        const points = stockChart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const productId = stockChart.data.datasets[firstPoint.datasetIndex].productIds[firstPoint.index];
                            const url = new URL("{{ url_for('inventory', _external=True) }}");
                            url.searchParams.set('product_id', productId);
                            window.location.href = url.toString();
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    }
                }
            });
        }

        // --- Gráfico de Pastel (Análisis de Vencimiento) ---
        if (document.getElementById('expirationChart')) {
            var expChartLabels = JSON.parse(document.getElementById('exp-chart-labels').textContent);
            var expChartData = JSON.parse(document.getElementById('exp-chart-data').textContent);
            var echartsData = expChartLabels.map(function(label, i) {
                return { value: expChartData[i], name: label };
            });
            const expChartDom = document.getElementById('expirationChart');
            const expChart = echarts.init(expChartDom);
            const totalUnidades = expChartData.reduce((a, b) => a + b, 0);
            const pastelColors = echartsData.map(d => {
                if (d.name.match(/0-3/i)) return 'red';
                if (d.name.match(/3-6/i)) return '#FFBF00';
                if (d.name.match(/6-9/i)) return 'yellow';
                if (d.name.match(/9-12/i)) return 'grey';
                if (d.name.match(/>12/i)) return 'green';
                return '#5B9BD5';
            });
            const option = {
                animation: false, // Desactiva la animación
                title: {
                    text: totalUnidades.toLocaleString('es-PE'),
                    subtext: 'Unidades Totales',
                    left: 'center', top: 'center',
                    textStyle: { fontSize: 30, fontWeight: 'bold' },
                    subtextStyle: { fontSize: 14 }
                },
                tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                legend: {
                    orient: 'horizontal',
                    left: 'center',
                    bottom: -50,
                    itemGap: 32,
                    textStyle: { fontSize: 14 }
                },
                series: [{
                    name: 'Estado de Vencimiento',
                    type: 'pie',
                    radius: ['60%', '80%'],
                    data: echartsData,
                    emphasis: {
                        itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' }
                    },
                    color: pastelColors
                }]
            };
            expChart.setOption(option);
            expChart.on('click', function (params) {
                const label = params.name;
                let status = '';
                if (label.startsWith('0-3')) { status = '0-3'; }
                else if (label.startsWith('3-6')) { status = '3-6'; }
                else if (label.startsWith('6-9')) { status = '6-9'; }
                else if (label.startsWith('9-12')) { status = '9-12'; }
                else if (label.startsWith('>12')) { status = '>12'; }
                if (status) {
                    const url = new URL("{{ url_for('inventory', _external=True) }}");
                    url.searchParams.set('exp_status', status);
                    const categoryId = JSON.parse(document.getElementById('selected-category-id').textContent);
                    const lineaId = JSON.parse(document.getElementById('selected-linea-id').textContent);
                    const lugarId = JSON.parse(document.getElementById('selected-lugar-id').textContent);
                    if (categoryId) { url.searchParams.set('grupo_id', categoryId); }
                    if (lineaId) { url.searchParams.set('linea_id', lineaId); }
                    if (lugarId) { url.searchParams.set('lugar_id', lugarId); }
                    window.location.href = url.toString();
                }
            });
            window.addEventListener('resize', () => { expChart.resize(); });
        }

        // --- NUEVO Gráfico de Barras Horizontales (Vencimiento por Línea) ---
        if (document.getElementById('expiringByLineChart')) {
            var expByLineLabels = JSON.parse(document.getElementById('exp-by-line-labels').textContent);
            var expByLineData = JSON.parse(document.getElementById('exp-by-line-data').textContent);
            const expByLineDom = document.getElementById('expiringByLineChart');
            const expByLineChart = echarts.init(expByLineDom);
            var selectedLineaId = JSON.parse(document.getElementById('selected-linea-id').textContent);
            var selectedLineaName = null;
            var lineaSelect = document.getElementById('linea_id');
            if (lineaSelect && selectedLineaId) {
                var selectedOption = lineaSelect.querySelector('option:checked');
                if (selectedOption) {
                    selectedLineaName = selectedOption.textContent.trim();
                }
            }
            const barColors = expByLineLabels.map(label => {
                if (selectedLineaName && String(label).trim() === selectedLineaName) {
                    return '#E53935';
                }
                return '#875A7B';
            });
            const option = {
                animation: false, // Desactiva la animación
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                legend: { show: false },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', boundaryGap: [0, 0.01] },
                yAxis: {
                    type: 'category',
                    data: expByLineLabels
                },
                series: [{
                    name: 'Unidades por Vencer',
                    type: 'bar',
                    label: { show: true, position: 'right' },
                    data: expByLineData,
                    itemStyle: {
                        color: function(params) {
                            return barColors[params.dataIndex % barColors.length];
                        }
                    }
                }]
            };
            expByLineChart.setOption(option);
            window.addEventListener('resize', () => { expByLineChart.resize(); });
        }
    });
</script>
{% endblock %}