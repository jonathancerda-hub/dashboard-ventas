{% extends 'base.html' %}

{% block content %}
<header class="page-header">
    <h1 class="page-title">Inventario de Stock</h1>
    <div style="display: flex; gap: var(--space-2);">
        <!-- <a href="{{ url_for('inventory_export') }}" class="btn">Inv. Exportación</a> -->
        <a href="{{ url_for('dashboard') }}" class="btn">Ver Dashboard</a> 
        <!-- <a href="{{ url_for('export_excel', **selected_filters) }}" class="btn btn--excel">
            <i class="bi bi-file-earmark-spreadsheet"></i> Exportar a Excel
        </a>-->
        <a href="{{ url_for('logout') }}" class="btn btn--primary">Cerrar Sesión</a>
    </div>
</header>

<div class="filter-bar">
    <form method="POST" action="{{ url_for('inventory') }}">
        <div style="display: flex; flex-wrap: wrap; gap: var(--space-3); align-items: flex-end;">
            
            <div>
                <label for="grupo_id" style="font-size: var(--font-size-sm); margin-bottom: var(--space-2); display: block;">Grupo Artículo</label>
                <select name="grupo_id" id="grupo_id" class="form-control">
                    <option value="">Todos</option>
                    {% for grupo in filter_options.grupos %}
                        <option value="{{ grupo.id }}" {% if grupo.id == selected_filters.grupo_id %}selected{% endif %}>
                            {{ grupo.display_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="linea_id" style="font-size: var(--font-size-sm); margin-bottom: var(--space-2); display: block;">Línea Comercial</label>
                <select name="linea_id" id="linea_id" class="form-control">
                    <option value="">Todas</option>
                    {% for linea in filter_options.lineas %}
                        <option value="{{ linea.id }}" {% if linea.id == selected_filters.linea_id %}selected{% endif %}>
                            {{ linea.display_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="lugar_id" style="font-size: var(--font-size-sm); margin-bottom: var(--space-2); display: block;">Lugar</label>
                <select name="lugar_id" id="lugar_id" class="form-control">
                    <option value="">Todos (def. Comercial)</option>
                    {% for lugar in filter_options.lugares %}
                        <option value="{{ lugar.id }}" {% if lugar.id == selected_filters.lugar_id %}selected{% endif %}>
                            {{ lugar.display_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div style="flex-grow: 1;">
                <label for="search_term" style="font-size: var(--font-size-sm); margin-bottom: var(--space-2); display: block;">Búsqueda</label>
                <input type="text" name="search_term" placeholder="..." value="{{ selected_filters.search_term or '' }}" class="form-control">
            </div>
            
            <button type="submit" class="btn btn--secondary">Buscar</button>
            <a href="{{ url_for('inventory') }}" class="btn btn--secondary">Limpiar</a>
        </div>
    </form>
</div>

<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>GrupoArticulo</th>
                <th>Linea Comercial</th>
                <th>CodArticulo</th>
                <th>Producto</th>
                <th>Lugar</th>
                
                <th class="col-no-wrap">FechaExpira</th>
                <th class="text-center">Cantidad disponible</th>
                <th class="text-center">Meses Expira</th>
            </tr>
        </thead>
        <tbody>
            {% for item in inventory %}
            <tr>
                <td>{{ item.grupo_articulo }}</td>
                <td>{{ item.linea_comercial }}</td>
                <td>{{ item.cod_articulo }}</td>
                <td>{{ item.producto }}</td>
                <td>{{ item.lugar }}</td>
                <td class="col-no-wrap">{{ item.fecha_expira }}</td>
                <td class="text-">{{ item.cantidad_disponible }}</td>
                {% set meses = item.meses_expira %}
                {% set status_class = '' %}
                {% if meses is not none and 0 <= meses <= 3 %}{% set status_class = 'status-vence-pronto' %}{% elif meses is not none and 4 <= meses <= 7 %}{% set status_class = 'status-advertencia' %}{% elif meses is not none and 8 <= meses <= 12 %}{% set status_class = 'status-ok' %}{% endif %}
                <td class="text-center {{ status_class }}">{{ meses if meses is not none else 'N/A' }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="10" style="text-align: center; padding: var(--space-4);">No se encontraron productos para la búsqueda.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}